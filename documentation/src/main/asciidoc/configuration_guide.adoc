= Configuration guide
B2i Healthcare Ltd. <info@b2international.com>
:toc2:
:icons: font

== Introduction

This document helps configuring each installed component for use with Snow Owl Server.

== Components

=== Operating system

Install `system-config-firewall-tui`:

--------------------------
# yum install dbus dbus-python system-config-firewall-tui
# reboot
--------------------------

Using the text-based UI, enable these Trusted Services:

SSH:: For remote administration of the server
WWW (HTTP):: For accessing Bugzilla's SOAP API and web-based UI

Also open access to the following ports:

8080/TCP:: Used by Snow Owl Server's REST API
2036/TCP:: Used by the Net4J binary protocol connecting Snow Owl clients to the server
11389/TCP:: Used by the LDAP server

=== Database server software

Edit `/etc/my.cnf` to adjust settings for the MySQL server. Recommended settings are shown below, but there are lots
of additional tunable settings to choose from depending on the hardware configuration used; please see
https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html for the full set of system variables.

./etc/my.cnf
--------------------------
include::configuration/my.cnf[]
--------------------------

Restart the mysql service to make sure changes are picked up:
--------------------------
# service mysqld restart
Stopping mysqld:                                           [  OK  ]
Starting mysqld:                                           [  OK  ]
--------------------------

Create a MySQL user for the Snow Owl Server by connecting to the DBMS via the console:

--------------------------
$ mysql -u root -p
Enter password: root_pwd // <1>

mysql> CREATE USER 'snowowl'@'localhost' IDENTIFIED BY 'snowowl_pwd'; // <2>
--------------------------
<1> Replace `root_pwd` with the password for the `root` user in MySQL
<2> Replace `snowowl_pwd` with a generated password for the `snowowl` user in MySQL

Save the following shell script to an executable file to create databases and grant privileges for user `snowowl`:

.snowowl_create_db.sh
--------------------------
include::scripts/snowowl_create_db.sh[]
--------------------------

B2i provided MySQL dumps (if present) can be found in `/opt/snowowl-community_{version}/resources/*.sql` files 
after unpacking the installation archive. To load terminology data, save and execute the following script:

.snowowl_load_db.sh
--------------------------
include::scripts/snowowl_load_db.sh[]
--------------------------

=== LDAP

==== Setting up a connection from Apache Directory Studio

Open Apache Directory Studio, create a new connection using the first button on the "`Connections`" toolbar:

image::ldap_new_connection.png[role="text-center"]

Enter connection name, hostname, and port, then hit `Next >` to go to the next page in the wizard:

image::ldap_new_connection_page1.png[role="text-center"]

Set authentication method to `Simple Authentication`, enter Bind DN `uid=admin,ou=system` and password `secret`. Click 
`Check Authentication` to make sure the values are accepted, then dismiss the wizard with `Finish`:

image::ldap_new_connection_page2.png[role="text-center"]

After connecting, you are advised to change the default password for user `system`. In order to do so, expand node 
`ou=system` and select the person `admin`. The editor will now display related user information:

image::ldap_admin_user_details.png[role="text-center"]

Double click on `userPassword` to open the password change dialog, select `SSHA-512` as the hash method. To see the new
password as it is being entered, check `Show next password details`:

image::ldap_change_password.png[role="text-center"]

To see if the password was changed successfully:

* Close the connection using the third button on the lower left toolbar named `Close Connection`, 
* Right-click the item representing the connection to open its properties with the context menu item at the bottom,
* Change the previously entered default bind password to the updated value on the `Authentication` tab,
* Re-connect to the server using `Open Connection`. 

==== Creating a partition for Snow Owl Server

Right-click on the item representing the connection, and select "Open Configuration":

image::ldap_connection_context_menu.png[role="text-center"]

An editor opens with the server configuration; select the `Partitions` tab. An `examples` partition is added by default,
which should be removed. Add a new partition named `snowowl` and fill out the details (ID and suffix):

image::ldap_configuration.png[role="text-center"]

Save the editor and restart the server to apply changes in partitions.

--------------------------
# service apacheds-2.0.0_M12-default restart
Stopping ApacheDS - default...
Stopped ApacheDS - default.
Starting ApacheDS - default...
--------------------------

==== Using LDIF dumps

B2i provided LDAP packages include the following content:

schema.ldif:: LDAP schema to use for authorization (contains definitions for permissionId and role)
permissions.ldif:: All available permissions in the system
roles.ldif:: All available roles in the system
pm.ldif:: Maps permissions to roles
update.sh:: An update script using `ldapmodify` and `ldapadd` commands against a running LDAP instance to update it 
based on the files above

Optionally the assembly can contain two additional files:

users.ldif:: All users available in the system
rm.ldif:: Maps roles to users in the system

The update script will also make use of these files if any of them exist.

Install the `openldap-clients` first to make use of the script:

--------------------------
# yum install openldap-clients
--------------------------

Before updating the LDAP server, it is advised to shut down the service, and create a backup from the contents 
of folder `/var/lib/apacheds-2.0.0_M12/default`, so it can be restored easily if the script fails.

Restart the server, then create a new ldif-<version> folder and unzip the contents of the LDIF archive into
this folder. Finally, execute the script to update the contents of LDAP: 

--------------------------
# chmod u+x update.sh

# ./update.sh
Not specified LDAP URI parameter, using ldap://localhost:10389
adding new entry "cn=permission, ou=schema"
adding new entry "ou=attributeTypes, cn=permission, ou=schema"
...
modifying entry...
--------------------------

In case an error occurs, the executed command and the error response will be displayed. Errors will also be logged 
to a `{file_name}.errors` file, where the `{file_name}` refers to the file being processed (eg. `permissions.errors`).

When executing the script it is possible to get the following errors:

* `ERR_250_ALREADY_EXISTS` (or any synonym of ALREADY_EXISTS)
* `ERR_54 Cannot add a value which is already present : snomed:compare:automap`
* `ERR_335 Oid 2.25.128424792425578037463837247958458780603.1 for new schema entity is not unique`

This is expected as most of the time the LDAP instance will already contain an existing definition of some entries and/or
schema entities. If you notice other errors (either during script execution or when using the LDAP), roll back your instance
to a previous state from a backup.

By default the update script will execute against the LDAP instance running locally at `ldap://localhost:10389`; if 
you'd like to run the script against a remote LDAP server (or the LDAP is listening on a different port), you can do it by 
specifying the LDAP_URI parameter:

--------------------------
# ./update.sh ldap://<host>:<port>
--------------------------

==== Configuring Snow Owl Server for LDAP

Set the administrator password and the LDAP server host by editing 
`/opt/snowowl-community_{version}/configuration/snowowl_jaas_configuration.properties`:

--------------------------
LDAP {
    org.eclipse.equinox.security.auth.module.ExtensionLoginModule required
        extensionId="com.b2international.snowowl.authentication.ldap.ldapLoginModule"
        ....
        userProvider="ldap://<ldap_host>:10389/" // <1>
        ....
        bindDnUser="uid=admin,ou=system"
        bindDnPassword="secret" // <2>
};
--------------------------
<1> Replace `<ldap_host>` with the host name or IP running the LDAP server to authenticate against
<2> Change `secret` to the LDAP administrator user's new password

Also change the following section of `/opt/snowowl-community_{version}/snowowl_config.yml` to enable LDAP authentication and
authorization:

--------------------------
authentication:
  type: PROP_FILE // <1>
  
fileAuth: // <2>
  users:
    -
      username: snowowl
      password: snowowl
--------------------------
<1> Change `PROP_FILE` to `LDAP`
<2> Remove the `fileAuth` key and sub-keys entirely

==== Creating a new user from Directory Studio

Go to LDAP Browser view, right click on the Domain component (DC) and add new entry via `New` > `New entry`:

image::ldap_new_user_context_menu.png[role="text-center"]

Create a new entry from scratch:

image::ldap_new_user_new_entry.png[role="text-center"]

Select `inetOrgPreson` object from the wizard, add it as a selected object class:

image::ldap_new_user_class.png[role="text-center"]

Configure the Relative Distinguished Name (RDN). Specify the common name (CN), surname (SN) and unique ID (uid):

image::ldap_new_user_rdn.png[role="text-center"]

Open the added node in an editor, right click in the editor and select `New Attribute`:

image::ldap_new_user_new_attribute.png[role="text-center"]

Select `userPassword` attribute, click `Finish`, then enter user password in the `Password Editor` dialog:

image::ldap_new_user_password.png[role="text-center"]

Finally, add a `uniqueMember` attribute to the Administrator group.

Select the new user's node in the tree, right click and select `Copy Entry / DN`:

image::ldap_new_user_copy_entry.png[role="text-center"]

Right click the `uniqueMember` attribute of the `Administrator` node, select `New Value` and paste the previously copied DN
of the new user as the value:

image::ldap_new_user_add_to_group.png[role="text-center"]

The operation takes place after pressing Enter or removing the focus from the edited field.
